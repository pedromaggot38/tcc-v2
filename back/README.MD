# Back-End - Sistema de Gest√£o do Hospital de Maraca√≠

![Node.js](https://img.shields.io/badge/Node.js-339933?style=for-the-badge&logo=nodedotjs&logoColor=white) ![Express.js](https://img.shields.io/badge/Express.js-000000?style=for-the-badge&logo=express&logoColor=white) ![Prisma](https://img.shields.io/badge/Prisma-2D3748?style=for-the-badge&logo=prisma&logoColor=white) ![PostgreSQL](https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white) ![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white)

Este diret√≥rio cont√©m o back-end completo do sistema informativo do Hospital de Maraca√≠. Desenvolvido em **Node.js** com **Express**, a aplica√ß√£o segue uma arquitetura em camadas robusta, projetada para ser segura, escal√°vel e de f√°cil manuten√ß√£o.

## ‚ú® Features Principais

### üõ°Ô∏è Autentica√ß√£o e Gest√£o de Acesso

- **Sistema de Roles:** Controle de permiss√£o granular com tr√™s n√≠veis de acesso: `journalist`, `admin` e `root`.
- **Autentica√ß√£o com JWT:** Sistema seguro de autentica√ß√£o baseado em JSON Web Tokens, com tokens armazenados em cookies `httpOnly` para maior seguran√ßa.
- **Setup Inicial Seguro:** Rota para cria√ß√£o do primeiro usu√°rio `root`, com bloqueio para impedir m√∫ltiplos superusu√°rios.
- **Recupera√ß√£o de Senha:** Fluxo completo de "esqueci minha senha" com envio de token seguro por e-mail (via Brevo).
- **Hierarquia de Permiss√µes:** Middleware (`checkUserHierarchy`) que impede que administradores editem ou desativem contas de n√≠vel igual ou superior.

### üë§ Gest√£o de Usu√°rios (Admin)

- **CRUD Completo:** Opera√ß√µes de criar, listar, ver, atualizar e deletar usu√°rios.
- **Transfer√™ncia de Root:** Rota segura para o `root` transferir sua fun√ß√£o para outro administrador, exigindo confirma√ß√£o por senha.
- **Ativa√ß√£o/Desativa√ß√£o de Contas:** Rotas para `root` ou `admin` gerenciarem o status das contas de usu√°rios.
- **Gest√£o de Perfil Pessoal:** Rotas `/me` para que qualquer usu√°rio autenticado possa gerenciar suas pr√≥prias informa√ß√µes.

### üì∞ Gest√£o de Not√≠cias (Articles)

- **CRUD Completo:** Gerenciamento total de not√≠cias com permiss√µes baseadas na role do usu√°rio.
- **Controle de Status:** Ciclo de vida de not√≠cias com os status `published`, `draft` ou `archived`.
- **Gera√ß√£o Autom√°tica de Slug:** URLs amig√°veis (`slugs`) geradas automaticamente a partir do t√≠tulo para SEO.
- **Sanitiza√ß√£o de HTML:** Prote√ß√£o autom√°tica contra ataques de Cross-Site Scripting (XSS) no conte√∫do das not√≠cias.

### ü©∫ Gest√£o de M√©dicos (Doctors)

- **CRUD Completo:** Gerenciamento de informa√ß√µes de m√©dicos, incluindo especialidade, CRM e contatos.
- **Gest√£o de Agendas:** Sistema flex√≠vel para criar e atualizar os hor√°rios de atendimento de cada m√©dico.
- **Controle de Visibilidade:** Rota dedicada para controlar quais m√©dicos aparecem no site p√∫blico.

### ‚öôÔ∏è Qualidade de C√≥digo e Seguran√ßa

- **Arquitetura em Camadas:** C√≥digo organizado em `routes`, `controllers` e `services` para m√°xima separa√ß√£o de responsabilidades.
- **Valida√ß√£o com Zod:** Middleware de valida√ß√£o que garante a integridade dos dados em todas as rotas de entrada.
- **Tratamento de Erros Avan√ßado:** Um `errorController` global captura e formata todos os erros, fornecendo mensagens amig√°veis em produ√ß√£o e detalhes t√©cnicos em desenvolvimento.
- **Prisma Middleware:** Hashing de senhas automatizado antes de qualquer opera√ß√£o de escrita no banco de dados.
- **Seguran√ßa HTTP:**
  - `helmet`: Adiciona cabe√ßalhos de seguran√ßa para proteger contra vulnerabilidades conhecidas.
  - `hpp`: Previne ataques de HTTP Parameter Pollution.
  - `express-rate-limit`: Mitiga ataques de for√ßa bruta limitando o n√∫mero de requisi√ß√µes.

## üõ†Ô∏è Tecnologias Utilizadas

- **Framework:** Node.js com Express.js
- **ORM:** Prisma com PostgreSQL
- **Autentica√ß√£o:** JSON Web Token (JWT) e `bcrypt.js`
- **Valida√ß√£o:** Zod
- **Seguran√ßa:** Helmet, HPP, Express Rate Limit
- **Envio de E-mail:** Brevo (anteriormente Sendinblue)
- **Containeriza√ß√£o:** Docker e Docker Compose

## üì¶ Pr√©-requisitos

- [Node.js](https://nodejs.org/en/) (vers√£o 18 ou superior)
- [Docker](https://www.docker.com/products/docker-desktop/) e Docker Compose
- Um cliente de API, como [Postman](https://www.postman.com/) ou [Insomnia](https://insomnia.rest/).

## üöÄ Como Executar

As instru√ß√µes completas para executar o projeto (front-end e back-end) est√£o no `README.md` principal, na raiz do reposit√≥rio.

### Executando Apenas o Back-End

1.  **Clone o reposit√≥rio:**

    ```bash
    git clone <url_do_seu_repositorio>
    cd tcc-v2
    ```

2.  **Crie o arquivo de ambiente:**
    Navegue at√© a pasta `back` e crie uma c√≥pia do arquivo `env.example`, renomeando-a para `.env`.

    ```bash
    cd back
    cp env.example .env
    ```

3.  **Preencha as vari√°veis de ambiente** no arquivo `.env` com suas configura√ß√µes (banco de dados, JWT, etc.).

4.  **Inicie os containers Docker:**
    A partir da raiz do projeto (`tcc-v2`), execute:
    ```bash
    docker-compose up -d --build
    ```
    O servidor estar√° dispon√≠vel em `http://localhost:3000`.

## üìÇ Estrutura de Diret√≥rios

```
back/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/         # Configura√ß√µes (DB, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ controllers/    # L√≥gica de requisi√ß√£o/resposta (req, res)
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/    # Fun√ß√µes que rodam entre a requisi√ß√£o e o controller
‚îÇ   ‚îú‚îÄ‚îÄ models/         # Schemas de valida√ß√£o (Zod)
‚îÇ   ‚îú‚îÄ‚îÄ routes/         # Defini√ß√£o dos endpoints da API
‚îÇ   ‚îú‚îÄ‚îÄ services/       # L√≥gica de neg√≥cio e comunica√ß√£o com o banco
‚îÇ   ‚îî‚îÄ‚îÄ utils/          # Fun√ß√µes utilit√°rias (tratamento de erro, etc.)
‚îú‚îÄ‚îÄ prisma/             # Schema do banco e migra√ß√µes
‚îî‚îÄ‚îÄ server.js           # Ponto de entrada da aplica√ß√£o
```

## üó∫Ô∏è Endpoints da API

A API √© versionada (`/api/v1`) e dividida em duas √°reas principais: `public` e `admin`.

---

### ` /api/v1/public`

- `GET /articles`: Lista artigos publicados.
- `GET /articles/:slug`: Retorna um artigo espec√≠fico pelo seu slug.
- `GET /doctors`: Lista m√©dicos com visibilidade ativa.

---

### ` /api/v1/admin/auth`

- `GET /check-root`: Verifica se o usu√°rio root j√° existe.
- `POST /create-root`: Cria o primeiro usu√°rio root do sistema.
- `POST /login`: Autentica um usu√°rio e retorna um JWT em um cookie.
- `GET /logout`: Limpa o cookie de autentica√ß√£o do usu√°rio.
- `POST /forgot-password`: Inicia o fluxo de recupera√ß√£o de senha.
- `PATCH /reset-password/:token`: Finaliza a redefini√ß√£o de senha com um novo password.

---

### ` /api/v1/admin`

- **/users**: Gerenciamento completo de usu√°rios.
- **/doctors**: Gerenciamento completo de m√©dicos e suas agendas.
- **/articles**: Gerenciamento completo de not√≠cias.

_(Para detalhes sobre cada rota, como `POST /users`, `PATCH /doctors/:id`, consulte o c√≥digo-fonte em `src/routes/`)_

### Exemplo: Criando um Novo M√©dico

**Requisi√ß√£o:** `POST /api/v1/admin/doctors`

**Headers:**
`Cookie: jwt=<seu_token>`

**Corpo (Body):**

```json
{
  "name": "Dr. Jo√£o da Silva",
  "specialty": "Cardiologia",
  "state": "SP",
  "crm": "123456",
  "schedules": [
    {
      "dayOfWeek": "segunda",
      "startTime": "08:00",
      "endTime": "12:00"
    },
    {
      "dayOfWeek": "quarta",
      "startTime": "14:00",
      "endTime": "18:00"
    }
  ]
}
```

**Resposta de Sucesso (C√≥digo 201):**

```json
{
  "status": "success",
  "message": "M√©dico criado com sucesso.",
  "data": {
    "doctor": {
      "id": 1,
      "name": "Dr. Jo√£o da Silva",
      "specialty": "Cardiologia"
      // ... outros campos
    }
  }
}
```
